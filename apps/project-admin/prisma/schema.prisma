// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Tenant {
  id                  String   @id @default(cuid())
  businessName        String
  slug                String   @unique
  domain              String   @unique
  username            String   @unique
  password            String
  ownerName          String
  ownerEmail         String
  phone              String?
  plan               String   @default("Standard")
  status             String   @default("active")
  address            String?
  businessType       String   @default("other")
  businessDescription String?
  monthlyRevenue     Int      @default(0)
  appointmentCount   Int      @default(0)
  customerCount      Int      @default(0)
  createdAt          DateTime @default(now())
  lastLogin          DateTime?
  
  // Subscription package fields
  subscriptionPlan   String?  // "trial", "monthly", "yearly"
  subscriptionStart  DateTime?
  subscriptionEnd    DateTime?
  
  // JSON fields for complex data
  workingHours       String?  // JSON string
  theme              String?  // JSON string

  // Payment settings
  cardPaymentEnabled Boolean  @default(true) @map("card_payment_enabled")

  @@map("tenants")
}

model Integration {
  id          String   @id @default(cuid())
  name        String
  type        String
  status      String   @default("active")
  description String?
  tenantCount Int      @default(0)
  lastUpdate  DateTime @default(now())
  
  @@map("integrations")
}

model SupportTicket {
  id          String   @id @default(cuid())
  tenantId    String
  tenantName  String
  subject     String
  description String
  priority    String   @default("medium")
  status      String   @default("open")
  assignedTo  String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("support_tickets")
}

model SlaMetric {
  id                    String @id @default(cuid())
  tenantId             String
  tenantName           String
  uptime               Float
  responseTime         Float
  ticketResolutionTime Float
  month                String
  
  @@map("sla_metrics")
}

model Admin {
  id        String   @id @default(cuid())
  username  String   @unique
  password  String   // MD5 hashed
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  lastLogin DateTime?
  
  @@map("admins")
}

model Appointment {
  id           String   @id @default(cuid())
  tenantId     String
  customerId   String
  customerName String
  customerPhone String?
  customerEmail String?
  serviceId    String
  serviceName  String
  staffId      String
  staffName    String
  date         String
  time         String
  status       String   @default("scheduled")
  notes        String?
  price        Float?
  duration     Int?     // in minutes
  paymentType  String   @default("cash")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  refundCompleted   Boolean?  @default(false)
  refundCompletedAt DateTime? @db.Timestamp(6)
  refundNotes       String?

  @@map("appointments")
}

model Customer {
  id          String   @id @default(cuid())
  tenantId    String
  firstName   String
  lastName    String
  email       String
  phone       String?
  birthDate   DateTime?
  gender      String?
  address     String?
  notes       String?
  status      String   @default("active")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([tenantId, email])
  @@map("customers")
}

model SubscriptionPackage {
  id           String   @id @default(cuid())
  name         String   // "15 Günlük Deneme", "Aylık Premium"
  slug         String   @unique // "trial", "monthly", "yearly"
  durationDays Int      // 15, 30, 365
  price        Float    @default(0) // 0 = ücretsiz
  isActive     Boolean  @default(true)
  isFeatured   Boolean  @default(false) // Öne çıkan paket (özel badge)
  displayOrder Int      @default(0)
  features     String?  @db.Text // JSON array: ["Sınırsız randevu", "100 müşteri"]
  description  String?  // Kısa açıklama
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  @@map("subscription_packages")
}

model Page {
  id        String   @id @default(cuid())
  slug      String   @unique // "hakkimizda", "gizlilik"
  title     String
  content   String   @db.Text
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("pages")
}

model Payment {
  id              String   @id @default(cuid())
  tenantId        String?  @map("tenant_id")
  appointmentId   String?  @map("appointment_id")
  customerId      String?  @map("customer_id")
  customerName    String?  @map("customer_name")
  customerEmail   String?  @map("customer_email")
  customerPhone   String?  @map("customer_phone")
  productName     String?  @map("product_name") // Ürün/hizmet adı (subscription paket adı vb.)
  merchantOid     String   @unique @map("merchant_oid")
  amount          Float
  paymentAmount   Int      @map("payment_amount")
  currency        String   @default("TL")
  status          String   @default("pending")
  paymentType     String?  @map("payment_type")
  paytrToken      String?  @map("paytr_token") @db.Text
  paytrHash       String?  @map("paytr_hash")
  failedReason    String?  @map("failed_reason")
  refundStatus    String?  @map("refund_status")
  refundAmount    Float?   @map("refund_amount")
  refundedAt      DateTime? @map("refunded_at")
  refundReason    String?  @map("refund_reason") @db.Text
  userIp          String?  @map("user_ip")
  userBasket      String?  @map("user_basket") @db.Text
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  paidAt          DateTime? @map("paid_at")

  @@index([merchantOid])
  @@index([appointmentId])
  @@index([status])
  @@index([tenantId])
  @@map("payments")
}

model Transaction {
  id            String   @id @default(cuid())
  tenantId      String
  type          String
  amount        Float
  description   String
  paymentType   String?
  customerId    String?
  customerName  String?
  productId     String?
  productName   String?
  quantity      Int?
  cost          Float?
  profit        Float?
  appointmentId String?
  date          String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  packageId     String?
  staffId       String?
  staffName     String?

  @@map("transactions")
}
