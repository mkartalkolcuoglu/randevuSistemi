// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Staff {
  id            String   @id @default(cuid())
  tenantId      String
  firstName     String
  lastName      String
  email         String   @unique
  phone         String?
  position      String
  status        String   @default("active")
  avatar        String?
  salary        Float?
  hireDate      String?
  specializations String? // JSON string for array of specializations
  experience    Int?     // years of experience
  rating        Float?   @default(4.0)
  workingHours  String?  // JSON string for working hours
  notes         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@map("staff")
}

model Customer {
  id          String   @id @default(cuid())
  tenantId    String
  firstName   String
  lastName    String
  email       String
  phone       String?
  birthDate   DateTime?
  gender      String?
  address     String?
  notes       String?
  status      String   @default("active")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([tenantId, email])
  @@map("customers")
}

model Service {
  id          String   @id @default(cuid())
  tenantId    String
  name        String
  description String?
  price       Float
  duration    Int      // in minutes
  category    String?
  status      String   @default("active")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("services")
}

model Appointment {
  id           String   @id @default(cuid())
  tenantId     String
  customerId   String
  customerName String
  customerPhone String?
  customerEmail String?
  serviceId    String
  serviceName  String
  staffId      String
  staffName    String
  date         String
  time         String
  status       String   @default("scheduled")
  notes        String?
  price        Float?
  duration     Int?     // in minutes
  paymentType  String   @default("cash")
  packageInfo  String?  @db.Text // JSON string containing package usage info

  // Payment fields
  paymentStatus String  @default("pending") // pending, paid, package_used, failed
  paymentId     String? // Link to Payment record

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([paymentStatus])
  @@index([paymentId])
  @@map("appointments")
}

model Task {
  id          String   @id @default(cuid())
  tenantId    String
  title       String
  description String?
  assignedTo  String
  priority    String   @default("medium")
  status      String   @default("pending")
  dueDate     DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("tasks")
}

model Settings {
  id               String   @id @default(cuid())
  tenantId         String   @unique
  businessName     String
  businessAddress  String?
  businessPhone    String?
  businessEmail    String?
  workingHours     String?  // JSON string
  appointmentTimeInterval Int? @default(30) @map("appointment_time_interval") // Appointment time slot interval in minutes (5, 10, 15, 20, 30, 45, 60)
  notificationSettings String? // JSON string
  paymentSettings  String?  // JSON string
  themeSettings    String?  // JSON string for colors, fonts, etc.
  updatedAt        DateTime @updatedAt
  
  @@map("settings")
}

model Tenant {
  id                  String   @id @default(cuid())
  businessName        String
  slug                String   @unique
  domain              String   @unique
  username            String   @unique
  password            String
  ownerName          String
  ownerEmail         String
  phone              String?
  plan               String   @default("Standard")
  status             String   @default("active")
  address            String?
  businessType       String   @default("other")
  businessDescription String?
  monthlyRevenue     Int      @default(0)
  appointmentCount   Int      @default(0)
  customerCount      Int      @default(0)
  createdAt          DateTime @default(now())
  lastLogin          DateTime?

  // Subscription fields
  subscriptionStart  DateTime?
  subscriptionEnd    DateTime?

  // JSON fields for complex data
  workingHours       String?  // JSON string
  theme              String?  // JSON string

  @@map("tenants")
}

model Product {
  id          String   @id @default(cuid())
  tenantId    String
  name        String
  description String?
  category    String?
  price       Float?
  cost        Float?
  stock       Int      @default(0)
  minStock    Int      @default(0)
  barcode     String?
  sku         String?
  supplier    String?
  status      String   @default("active")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("products")
}

model Notification {
  id          String   @id @default(cuid())
  tenantId    String
  type        String   // 'new_appointment', 'appointment_cancelled', etc.
  title       String
  message     String
  link        String?  // Link to related page
  read        Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("notifications")
}

model Feedback {
  id              String   @id @default(cuid())
  tenantId        String
  appointmentId   String   @unique // Her randevuya 1 kere feedback
  customerName    String
  customerPhone   String
  rating          Int      // 1-5 yıldız
  comment         String?  // Opsiyonel yorum
  serviceName     String
  staffName       String
  appointmentDate String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("feedbacks")
}

model OtpVerification {
  id          String   @id @default(cuid())
  phone       String   // Telefon numarası
  code        String   // 6 haneli OTP kodu
  purpose     String   // 'appointment_query', 'subscription', 'password_reset', vb.
  tenantId    String?  @map("tenant_id") // Opsiyonel: Hangi tenant için (subscription için gerekli)
  expiresAt   DateTime @map("expires_at") // 120 saniye sonra
  verified    Boolean  @default(false)
  verifiedAt  DateTime? @map("verified_at")
  attempts    Int      @default(0) // Kaç kere denendi
  ipAddress   String?  @map("ip_address") // Güvenlik için IP kaydı
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([phone, purpose]) // Hızlı sorgulama için
  @@index([expiresAt]) // Cleanup için
  @@map("otp_verifications")
}

model Payment {
  id              String   @id @default(cuid())
  tenantId        String?  @map("tenant_id") // Nullable: İşletme kaydı için henüz tenant yok
  appointmentId   String?  @map("appointment_id") // Randevu için ödeme ise
  customerId      String?  @map("customer_id")
  customerName    String?  @map("customer_name")
  customerEmail   String?  @map("customer_email")
  customerPhone   String?  @map("customer_phone")

  // PayTR Bilgileri
  merchantOid     String   @unique @map("merchant_oid") // PayTR sipariş no (unique order ID)
  amount          Float    // Tutar (TL cinsinden, örn: 34.56)
  paymentAmount   Int      @map("payment_amount") // PayTR'a gönderilen tutar (3456 = 34.56 * 100)
  currency        String   @default("TL")

  // Ödeme Durumu
  status          String   @default("pending") // pending, success, failed
  paymentType     String?  @map("payment_type") // card, eft (PayTR'dan gelir)

  // PayTR Callback Bilgileri
  paytrToken      String?  @map("paytr_token") @db.Text // İlk alınan iframe token (log için)
  paytrHash       String?  @map("paytr_hash") // Callback'ten gelen hash
  failedReason    String?  @map("failed_reason") // Hata kodu/mesajı (failed_reason_code + failed_reason_msg)

  // Refund (İade) Bilgileri
  refundStatus    String?  @map("refund_status") // null, requested, processing, completed, failed
  refundAmount    Float?   @map("refund_amount") // İade tutarı
  refundedAt      DateTime? @map("refunded_at")
  refundReason    String?  @map("refund_reason") @db.Text

  // Meta Bilgiler
  userIp          String?  @map("user_ip")
  userBasket      String?  @map("user_basket") @db.Text // JSON: Sepet bilgisi (PayTR'a gönderilen)

  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  paidAt          DateTime? @map("paid_at") // Ödeme başarılı olduğu an

  @@index([merchantOid])
  @@index([appointmentId])
  @@index([status])
  @@index([tenantId])
  @@map("payments")
}
