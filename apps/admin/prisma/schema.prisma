// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Staff {
  id            String   @id @default(cuid())
  tenantId      String
  firstName     String
  lastName      String
  email         String   @unique
  phone         String?
  position      String
  status        String   @default("active")
  avatar        String?
  salary        Float?
  hireDate      String?
  specializations String? // JSON string for array of specializations
  experience    Int?     // years of experience
  rating        Float?   @default(4.0)
  workingHours  String?  // JSON string for working hours
  notes         String?
  
  // Authentication fields
  username      String?  @unique
  password      String?
  role          String?  @default("staff") // "owner", "manager", "staff"
  permissions   String?  @db.Text // JSON string for page permissions
  canLogin      Boolean  @default(false) @map("can_login")
  lastLogin     DateTime? @map("last_login")
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@map("staff")
}

model Customer {
  id                    String    @id @default(cuid())
  tenantId              String
  firstName             String
  lastName              String
  email                 String
  phone                 String?
  birthDate             DateTime?
  gender                String?
  address               String?
  notes                 String?
  status                String    @default("active")
  noShowCount           Int       @default(0) @map("no_show_count")
  isBlacklisted         Boolean   @default(false) @map("is_blacklisted")
  blacklistedAt         DateTime? @map("blacklisted_at")
  whatsappNotifications Boolean   @default(true) @map("whatsapp_notifications") // WhatsApp bildirim tercihi
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  
  customerPackages CustomerPackage[]
  
  @@unique([tenantId, email])
  @@map("customers")
}

model Service {
  id          String   @id @default(cuid())
  tenantId    String
  name        String
  description String?
  price       Float
  duration    Int      // in minutes
  category    String?
  status      String   @default("active")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("services")
}

model Appointment {
  id           String   @id @default(cuid()) @map("id")
  tenantId     String   @map("tenantId")
  customerId   String   @map("customerId")
  customerName String   @map("customerName")
  customerPhone String? @map("customerPhone")
  customerEmail String? @map("customerEmail")
  serviceId    String   @map("serviceId")
  serviceName  String   @map("serviceName")
  staffId      String   @map("staffId")
  staffName    String   @map("staffName")
  date         String   @map("date")
  time         String   @map("time")
  status       String   @default("scheduled") @map("status")
  notes        String?  @map("notes")
  price        Float?   @map("price")
  duration     Int?     @map("duration") // in minutes
  paymentType  String   @default("cash") @map("paymentType")
  packageInfo  String?  @db.Text @map("packageInfo") // JSON string containing package usage info

  // Payment fields
  paymentStatus String  @default("pending") @map("paymentStatus") // pending, paid, package_used, failed
  paymentId     String? @map("paymentId") // Link to Payment record

  whatsappSent   Boolean   @default(false) @map("whatsappSent")
  whatsappSentAt DateTime? @map("whatsappSentAt")
  reminderSent   Boolean   @default(false) @map("reminderSent")
  reminderSentAt DateTime? @map("reminderSentAt")
  createdAt      DateTime  @default(now()) @map("createdAt")
  updatedAt      DateTime  @updatedAt @map("updatedAt")

  @@index([paymentStatus])
  @@index([paymentId])
  @@map("appointments")
}

model Task {
  id          String   @id @default(cuid())
  tenantId    String
  title       String
  description String?
  assignedTo  String
  priority    String   @default("medium")
  status      String   @default("pending")
  dueDate     DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("tasks")
}

model Settings {
  id                      String   @id @default(cuid())
  tenantId                String   @unique
  businessName            String
  businessAddress         String?
  businessPhone           String?
  businessEmail           String?
  workingHours            String?  // JSON string
  appointmentTimeInterval Int?     @default(30) @map("appointment_time_interval") // Appointment time slot interval in minutes (5, 10, 15, 20, 30, 45, 60)
  blacklistThreshold      Int?     @default(3) @map("blacklist_threshold") // Number of no-shows before blacklisting (1-10)
  notificationSettings    String?  // JSON string
  paymentSettings         String?  // JSON string
  themeSettings           String?  // JSON string for colors, fonts, etc.
  updatedAt               DateTime @updatedAt
  
  @@map("settings")
}

model Tenant {
  id                  String   @id @default(cuid())
  businessName        String
  slug                String   @unique
  domain              String   @unique
  username            String   @unique
  password            String
  ownerName          String
  ownerEmail         String
  phone              String?
  plan               String   @default("Standard")
  status             String   @default("active")
  address            String?
  businessType       String   @default("other")
  businessDescription String?
  monthlyRevenue     Int      @default(0)
  appointmentCount   Int      @default(0)
  customerCount      Int      @default(0)
  createdAt          DateTime @default(now())
  lastLogin          DateTime?
  
  // Subscription package fields
  subscriptionPlan   String?  // "trial", "monthly", "yearly"
  subscriptionStart  DateTime?
  subscriptionEnd    DateTime?
  
  // JSON fields for complex data
  workingHours       String?  // JSON string
  theme              String?  // JSON string
  
  @@map("tenants")
}

model Product {
  id          String   @id @default(cuid())
  tenantId    String
  name        String
  description String?
  category    String?
  price       Float?
  cost        Float?
  stock       Int      @default(0)
  minStock    Int      @default(0)
  barcode     String?
  sku         String?
  supplier    String?
  status      String   @default("active")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("products")
}

model Transaction {
  id              String   @id @default(cuid())
  tenantId        String
  type            String   // 'income' (gelir), 'expense' (gider), 'sale' (satış), 'appointment' (randevu), 'package' (paket satışı)
  amount          Float
  description     String
  paymentType     String?  // 'cash', 'card', 'transfer'
  customerId      String?  // For sales
  customerName    String?
  productId       String?  // For sales
  productName     String?
  quantity        Int?     // For sales
  cost            Float?   // Product cost for profit calculation
  profit          Float?   // Calculated profit (amount - cost)
  appointmentId   String?  // Link to appointment if type is 'appointment'
  packageId       String?  // Link to package if type is 'package'
  staffId         String?  // Staff member who made the sale/transaction
  staffName       String?  // Staff member name
  date            String   // Transaction date
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@map("transactions")
}

model Notification {
  id          String   @id @default(cuid())
  tenantId    String
  type        String   // 'new_appointment', 'appointment_cancelled', etc.
  title       String
  message     String
  link        String?  // Link to related page
  read        Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("notifications")
}

model Package {
  id          String   @id @default(cuid())
  tenantId    String
  name        String
  description String?
  price       Float
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  items       PackageItem[]
  customerPackages CustomerPackage[]
  
  @@map("packages")
}

model PackageItem {
  id          String   @id @default(cuid())
  packageId   String
  itemType    String   // 'service' or 'product'
  itemId      String   // serviceId or productId
  itemName    String   // service name or product name
  quantity    Int      // number of sessions/items
  createdAt   DateTime @default(now())
  
  package     Package  @relation(fields: [packageId], references: [id], onDelete: Cascade)
  
  @@map("package_items")
}

model CustomerPackage {
  id          String   @id @default(cuid())
  customerId  String
  packageId   String
  tenantId    String
  assignedAt  DateTime @default(now())
  expiresAt   DateTime?
  status      String   @default("active") // active, completed, expired
  staffId     String?  // Staff member who assigned/sold the package
  staffName   String?  // Staff member name
  
  customer    Customer @relation(fields: [customerId], references: [id])
  package     Package  @relation(fields: [packageId], references: [id])
  usages      CustomerPackageUsage[]
  
  @@unique([customerId, packageId]) // Prevent duplicate assignments
  @@map("customer_packages")
}

model CustomerPackageUsage {
  id                  String   @id @default(cuid())
  customerPackageId   String
  itemType            String   // 'service' or 'product'
  itemId              String
  itemName            String
  totalQuantity       Int      // Starting quantity (e.g., 10)
  usedQuantity        Int      @default(0) // Used (e.g., 3)
  remainingQuantity   Int      // Remaining (e.g., 7)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  customerPackage     CustomerPackage @relation(fields: [customerPackageId], references: [id], onDelete: Cascade)
  
  @@map("customer_package_usage")
}

model Feedback {
  id              String   @id @default(cuid())
  tenantId        String
  appointmentId   String   @unique // Her randevuya 1 kere feedback
  customerName    String
  customerPhone   String
  rating          Int      // 1-5 yıldız
  comment         String?  // Opsiyonel yorum
  serviceName     String
  staffName       String
  appointmentDate String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("feedbacks")
}

model OtpVerification {
  id          String   @id @default(cuid())
  phone       String   // Telefon numarası
  code        String   // 6 haneli OTP kodu
  purpose     String   // 'appointment_query', 'subscription', 'password_reset', vb.
  tenantId    String?  // Opsiyonel: Hangi tenant için (subscription için gerekli)
  expiresAt   DateTime // 120 saniye sonra
  verified    Boolean  @default(false)
  verifiedAt  DateTime? @map("verified_at")
  attempts    Int      @default(0) // Kaç kere denendi
  ipAddress   String?  @map("ip_address") // Güvenlik için IP kaydı
  createdAt   DateTime @default(now())

  @@index([phone, purpose]) // Hızlı sorgulama için
  @@index([expiresAt]) // Cleanup için
  @@map("otp_verifications")
}

model Payment {
  id              String   @id @default(cuid())
  tenantId        String
  appointmentId   String?  // Randevu için ödeme ise
  customerId      String?
  customerName    String?
  customerEmail   String?
  customerPhone   String?

  // PayTR Bilgileri
  merchantOid     String   @unique // PayTR sipariş no (unique order ID)
  amount          Float    // Tutar (TL cinsinden, örn: 34.56)
  paymentAmount   Int      // PayTR'a gönderilen tutar (3456 = 34.56 * 100)
  currency        String   @default("TL")

  // Ödeme Durumu
  status          String   @default("pending") // pending, success, failed
  paymentType     String?  // card, eft (PayTR'dan gelir)

  // PayTR Callback Bilgileri
  paytrToken      String?  @db.Text // İlk alınan iframe token (log için)
  paytrHash       String?  // Callback'ten gelen hash
  failedReason    String?  // Hata kodu/mesajı (failed_reason_code + failed_reason_msg)

  // Refund (İade) Bilgileri
  refundStatus    String?  // null, requested, processing, completed, failed
  refundAmount    Float?   // İade tutarı
  refundedAt      DateTime? @map("refunded_at")
  refundReason    String?  @db.Text

  // Meta Bilgiler
  userIp          String?  @map("user_ip")
  userBasket      String?  @db.Text // JSON: Sepet bilgisi (PayTR'a gönderilen)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  paidAt          DateTime? @map("paid_at") // Ödeme başarılı olduğu an

  @@index([merchantOid])
  @@index([appointmentId])
  @@index([status])
  @@index([tenantId])
  @@map("payments")
}
