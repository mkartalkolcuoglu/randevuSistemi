generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Staff {
  id              String    @id @default(cuid())
  tenantId        String
  firstName       String
  lastName        String
  email           String    @unique
  phone           String?
  position        String
  status          String    @default("active")
  avatar          String?
  salary          Float?
  hireDate        String?
  specializations String?
  experience      Int?
  rating          Float?    @default(4.0)
  workingHours    Json?
  notes           String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  username        String?   @unique
  password        String?
  role            String?   @default("staff")
  permissions     String?
  canLogin        Boolean   @default(false) @map("can_login")
  lastLogin       DateTime? @map("last_login")

  tenant       Tenant        @relation(fields: [tenantId], references: [id])
  services     Service[]
  appointments Appointment[]

  @@map("staff")
}

model Customer {
  id                    String    @id @default(cuid())
  tenantId              String
  firstName             String
  lastName              String
  email                 String
  phone                 String?
  birthDate             DateTime?
  gender                String?
  address               String?
  notes                 String?
  status                String    @default("active")
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  noShowCount           Int?      @default(0) @map("no_show_count")
  isBlacklisted         Boolean?  @default(false) @map("is_blacklisted")
  blacklistedAt         DateTime? @map("blacklisted_at") @db.Timestamp(6)
  whatsappNotifications Boolean?  @default(true) @map("whatsapp_notifications")

  tenant       Tenant        @relation(fields: [tenantId], references: [id])
  appointments Appointment[]

  @@unique([tenantId, email])
  @@index([whatsappNotifications], map: "idx_customers_whatsapp_notifications")
  @@map("customers")
}

model Service {
  id          String   @id @default(cuid())
  tenantId    String
  name        String
  description String?
  price       Float
  duration    Int
  category    String?
  status      String   @default("active")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant       Tenant        @relation(fields: [tenantId], references: [id])
  staff        Staff[]
  appointments Appointment[]

  @@map("services")
}

model Appointment {
  id               String    @id @default(cuid())
  tenantId         String
  customerId       String
  customerName     String
  customerPhone    String?
  customerEmail    String?
  serviceId        String
  serviceName      String
  staffId          String
  staffName        String
  date             String
  time             String
  status           String    @default("scheduled")
  notes            String?
  price            Float?
  duration         Int?
  paymentType      String    @default("cash")
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  packageInfo      String?
  whatsapp_sent    Boolean?  @default(false)
  whatsapp_sent_at DateTime? @db.Timestamp(6)
  reminder_sent    Boolean?  @default(false)
  reminder_sent_at DateTime? @db.Timestamp(6)
  payment_status   String?   @default("pending")
  payment_id       String?
  whatsappSent     Boolean?  @default(false)
  whatsappSentAt   DateTime? @db.Timestamp(6)
  reminderSent     Boolean?  @default(false)
  reminderSentAt   DateTime? @db.Timestamp(6)
  paymentStatus    String?   @default("pending")
  paymentId        String?
  refundCompleted   Boolean?  @default(false)
  refundCompletedAt DateTime? @db.Timestamp(6)
  refundNotes       String?

  tenant   Tenant   @relation(fields: [tenantId], references: [id])
  customer Customer @relation(fields: [customerId], references: [id])
  service  Service  @relation(fields: [serviceId], references: [id])
  staff    Staff    @relation(fields: [staffId], references: [id])

  @@index([payment_id], map: "idx_appointment_payment_id")
  @@index([payment_status], map: "idx_appointment_payment_status")
  @@index([paymentId], map: "idx_appointments_payment_id")
  @@index([paymentStatus], map: "idx_appointments_payment_status")
  @@index([reminder_sent], map: "idx_appointments_reminder_sent")
  @@index([status, date], map: "idx_appointments_status_date")
  @@index([whatsapp_sent], map: "idx_appointments_whatsapp_sent")
  @@map("appointments")
}

model Task {
  id          String    @id @default(cuid())
  tenantId    String
  title       String
  description String?
  assignedTo  String
  priority    String    @default("medium")
  status      String    @default("pending")
  dueDate     DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@map("tasks")
}

model Settings {
  id                      String   @id @default(cuid())
  tenantId                String   @unique
  businessName            String
  businessAddress         String?
  businessPhone           String?
  businessEmail           String?
  workingHours            String?
  notificationSettings    String?
  paymentSettings         String?
  themeSettings           String?
  updatedAt               DateTime @updatedAt
  appointmentTimeInterval Int?     @default(30) @map("appointment_time_interval")
  blacklistThreshold      Int?     @default(3) @map("blacklist_threshold")
  reminderMinutes         Int?     @default(120) @map("reminder_minutes")

  @@map("settings")
}

model Tenant {
  id                  String    @id @default(cuid())
  businessName        String
  slug                String    @unique
  domain              String    @unique
  username            String    @unique
  password            String
  ownerName           String
  ownerEmail          String
  ownerPhone          String?
  phone               String?
  plan                String    @default("Standard")
  status              String    @default("active")
  address             String?
  businessType        String    @default("other")
  businessDescription String?
  monthlyRevenue      Int       @default(0)
  appointmentCount    Int       @default(0)
  customerCount       Int       @default(0)
  createdAt           DateTime  @default(now())
  lastLogin           DateTime?
  workingHours        String?
  theme               String?
  subscriptionPlan    String?
  subscriptionStart   DateTime?
  subscriptionEnd     DateTime?
  hasUsedTrial        Boolean   @default(false) @map("has_used_trial")
  cardPaymentEnabled  Boolean?  @default(true) @map("card_payment_enabled")
  settings            Json?
  logo                String?
  primaryColor        String?

  staff        Staff[]
  customers    Customer[]
  services     Service[]
  appointments Appointment[]

  @@map("tenants")
}

model Product {
  id          String   @id @default(cuid())
  tenantId    String
  name        String
  description String?
  category    String?
  price       Float?
  cost        Float?
  stock       Int      @default(0)
  minStock    Int      @default(0)
  barcode     String?
  sku         String?
  supplier    String?
  status      String   @default("active")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("products")
}

model Transaction {
  id            String   @id @default(cuid())
  tenantId      String
  type          String
  amount        Float
  description   String
  paymentType   String?
  customerId    String?
  customerName  String?
  productId     String?
  productName   String?
  quantity      Int?
  cost          Float?
  profit        Float?
  appointmentId String?
  date          String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  packageId     String?
  staffId       String?
  staffName     String?

  @@map("transactions")
}

model Notification {
  id        String    @id @default(cuid())
  tenantId  String
  type      String
  title     String
  message   String
  link      String?
  read      Boolean?  @default(false)
  createdAt DateTime? @default(now()) @db.Timestamp(6)
  updatedAt DateTime? @default(now()) @updatedAt @db.Timestamp(6)

  @@index([createdAt(sort: Desc)], map: "idx_notifications_created_at")
  @@index([tenantId, read], map: "idx_notifications_tenant_read")
  @@map("notifications")
}

model Package {
  id          String   @id @default(cuid())
  tenantId    String
  name        String
  description String?
  price       Float
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("packages")
}

model PackageItem {
  id        String   @id @default(cuid())
  packageId String
  itemType  String
  itemId    String
  itemName  String
  quantity  Int
  createdAt DateTime @default(now())

  @@map("package_items")
}

model CustomerPackage {
  id         String    @id @default(cuid())
  customerId String
  packageId  String
  tenantId   String
  assignedAt DateTime  @default(now())
  expiresAt  DateTime?
  status     String    @default("active")
  staffId    String?
  staffName  String?

  @@unique([customerId, packageId])
  @@map("customer_packages")
}

model CustomerPackageUsage {
  id                String   @id @default(cuid())
  customerPackageId String
  itemType          String
  itemId            String
  itemName          String
  totalQuantity     Int
  usedQuantity      Int      @default(0)
  remainingQuantity Int
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@map("customer_package_usage")
}

model Feedback {
  id              String   @id @default(cuid())
  tenantId        String
  appointmentId   String   @unique
  customerName    String
  customerPhone   String
  rating          Int
  comment         String?
  serviceName     String
  staffName       String
  appointmentDate String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([createdAt(sort: Desc)])
  @@index([tenantId])
  @@map("feedbacks")
}

model OtpVerification {
  id         String    @id @default(cuid())
  phone      String
  code       String
  purpose    String
  tenantId   String?   @map("tenant_id")
  expiresAt  DateTime  @map("expires_at") @db.Timestamp(6)
  verified   Boolean   @default(false)
  verifiedAt DateTime? @map("verified_at") @db.Timestamp(6)
  attempts   Int       @default(0)
  ipAddress  String?   @map("ip_address")
  createdAt  DateTime  @default(now()) @map("created_at") @db.Timestamp(6)

  @@index([expiresAt], map: "idx_otp_expires_at")
  @@index([phone, purpose], map: "idx_otp_phone_purpose")
  @@map("otp_verifications")
}

model Payment {
  id            String    @id @default(cuid())
  tenantId      String?   @map("tenant_id")
  appointmentId String?   @map("appointment_id")
  customerId    String?   @map("customer_id")
  customerName  String?   @map("customer_name")
  customerEmail String?   @map("customer_email")
  customerPhone String?   @map("customer_phone")
  merchantOid   String    @unique @map("merchant_oid")
  amount        Float
  paymentAmount Int       @map("payment_amount")
  currency      String    @default("TL")
  status        String    @default("pending")
  paymentType   String?   @map("payment_type")
  paytrToken    String?   @map("paytr_token")
  paytrHash     String?   @map("paytr_hash")
  failedReason  String?   @map("failed_reason")
  refundStatus  String?   @map("refund_status")
  refundAmount  Float?    @map("refund_amount")
  refundedAt    DateTime? @map("refunded_at") @db.Timestamp(6)
  refundReason  String?   @map("refund_reason")
  userIp        String?   @map("user_ip")
  userBasket    String?   @map("user_basket")
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt     DateTime  @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)
  paidAt        DateTime? @map("paid_at") @db.Timestamp(6)
  productName   String?   @map("product_name") @db.VarChar(255)

  @@index([appointmentId], map: "idx_payment_appointment_id")
  @@index([merchantOid], map: "idx_payment_merchant_oid")
  @@index([status], map: "idx_payment_status")
  @@index([tenantId], map: "idx_payment_tenant_id")
  @@map("payments")
}

model SubscriptionPackage {
  id           String   @id @default(cuid())
  name         String
  slug         String   @unique
  durationDays Int
  price        Float    @default(0)
  isActive     Boolean  @default(true)
  isFeatured   Boolean  @default(false)
  displayOrder Int      @default(0)
  features     String?
  description  String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @default(now()) @updatedAt

  @@map("subscription_packages")
}

model admins {
  id        String    @id
  username  String    @unique
  password  String
  createdAt DateTime  @default(now()) @db.Timestamp(6)
  updatedAt DateTime  @default(now()) @db.Timestamp(6)
  lastLogin DateTime? @db.Timestamp(6)
}

model pages {
  id        String   @id
  slug      String   @unique
  title     String
  content   String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now()) @db.Timestamp(6)
  updatedAt DateTime @default(now()) @db.Timestamp(6)

  @@index([isActive], map: "idx_pages_is_active")
  @@index([slug], map: "idx_pages_slug")
}
